#!/bin/bash
DOMAIN=$1

mkdir -p /opt/certbot-auth/$DOMAIN/.well-known/acme-challenge/
rm -f /etc/nginx/conf.d/$DOMAIN-http.conf
cp /etc/nginx/conf.d/http.template /etc/nginx/conf.d/$DOMAIN-http.conf
sed -i "s/{DOMAIN}/$DOMAIN/g" /etc/nginx/conf.d/$DOMAIN-http.conf

nginx -s reload

certbot certonly \
  --manual \
  --authenticator manual \
  --manual-auth-hook /opt/bin/certbot-auth \
  --manual-cleanup-hook /opt/bin/certbot-auth-cleanup \
  --preferred-challenges=http \
  --non-interactive \
  --agree-tos \
  -m matthew.stephen.james@gmail.com \
  -d $1

rm -f /etc/nginx/conf.d/$DOMAIN-https.conf
cp /etc/nginx/conf.d/https.template /etc/nginx/conf.d/$DOMAIN-https.conf
sed -i "s/{DOMAIN}/$DOMAIN/g" /etc/nginx/conf.d/$DOMAIN-https.conf

nginx -s reload